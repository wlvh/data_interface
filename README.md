# Data Interface

高性能数据分析与可视化系统，基于Walmart零售数据（2010-2012），实现动态权重调参、交互式数据探索和实时统计分析。

## 项目概述

本项目是一个专注于零售数据分析的高性能可视化系统，采用模块化架构设计，实现了声明式参数管理、Web Worker安全沙箱和ECharts高性能渲染。系统能够处理45家门店的143周销售数据，支持多维度特征分析和实时交互。

### 🚀 POC演示系统

在 `poc/` 目录下包含了完整的生产级实现，展示了三大核心功能：

1. **门店活跃度动态权重调参** - 基于6维特征的实时评分系统（近端动量、节日提升、油价敏感度、气温敏感度、宏观适应性、稳健趋势）
2. **高级图表交互与智能提示** - ECharts驱动的柱状图和散点图，支持悬浮Sparkline展示
3. **散点圈选与即时聚合** - 支持矩形/套索选择，实时计算统计指标（均值、中位数、标准差、局部斜率）

## 快速开始

### POC系统运行

```bash
# 克隆仓库
git clone https://github.com/wlvh/data_interface.git

# 进入POC目录
cd data_interface/poc

# 安装依赖
npm install

# 启动开发服务器
npm run dev
```

访问 http://localhost:3000 查看完整演示

## 核心特性

### 技术架构

- **模块化系统设计** - 主入口(main.js) + 运行时模块(runtime/) + UI组件(ui/) + 契约系统(contract/)
- **声明式参数管理** - ParamManager统一管理所有参数，支持路径访问和事件驱动更新
- **Web Worker沙箱** - 基于Acorn的AST安全检查，隔离执行环境，5秒超时控制
- **ECharts可视化引擎** - Canvas高性能渲染，支持5万行柱状图和3万点散点图
- **智能特征工程** - 6维特征计算（滚动窗口26周），Z-score标准化，NA智能处理
- **可回放机制** - JSON快照导出/导入，UTC时间戳确保确定性

### 性能指标

- **滑块响应**: <500ms（6维权重实时更新）
- **图表渲染**: 柱状图支持5万条数据，散点图支持3万数据点
- **悬浮提示**: <16ms（单帧渲染，固定尺寸无抖动）
- **圈选聚合**: <200ms（Worker异步计算）
- **特征计算**: 滚动窗口26周，支持增量更新

### 安全机制

- **AST黑名单验证** - 禁用window/document/eval/fetch/XMLHttpRequest等危险标识符
- **语法白名单** - 仅允许安全的语句类型（变量声明、函数、循环、条件等）
- **深度数据冻结** - 输入数据使用Object.freeze防止修改
- **执行超时控制** - 默认5000ms，可配置最大10分钟
- **确定性执行** - 固定UTC时间(2025-09-13 12:00:00)，种子随机数生成器

## 项目结构

```
data_interface/
├── poc/                        # POC演示系统
│   ├── src/
│   │   ├── main.js            # 应用主入口，协调所有模块
│   │   ├── contract/          # 契约系统
│   │   │   └── schema.js      # 数据模式定义与校验
│   │   ├── runtime/           # 运行时核心
│   │   │   ├── dataProcessor.js    # 数据处理与特征工程
│   │   │   ├── params/
│   │   │   │   └── manager.js      # 参数集中管理
│   │   │   ├── worker/
│   │   │   │   ├── sandbox.js      # Worker沙箱执行器
│   │   │   │   └── slotWorker.js   # Worker线程代码
│   │   │   └── charts/
│   │   │       └── chartManager.js # ECharts管理器
│   │   └── ui/
│   │       └── panels/
│   │           └── parameterPanel.js # 参数面板UI
│   ├── public/                 # 静态资源
│   ├── index.html              # 主页面
│   ├── package.json            # 依赖配置
│   └── vite.config.js          # Vite构建配置
├── Walmart.csv                 # 数据集（45店×143周）
└── README.md                   # 本文件
```

## 功能详解

### 1. 动态权重调参系统
- **6维特征权重滑块** - 实时调整各特征对活跃度评分的贡献
  - 近端动量(Momentum): 近8周销售均值比率
  - 节日提升(Holiday): 节日周销售线性差
  - 油价敏感度(Fuel): 26周滚动回归系数
  - 气温敏感度(Temperature): 26周滚动回归系数
  - 宏观适应性(Macro): 与CPI/失业率相关性绝对值
  - 稳健趋势(Trend): 中位增量稳健估计
- **智能NA处理** - 自动剔除NA比例>30%的特征
- **实时评分更新** - 加权平均计算，Z-score标准化
- **柱状图动态排序** - 按活跃度降序展示TOP门店

### 2. 高级图表交互
- **ECharts柱状图** - 支持5万条数据，DataZoom缩放
- **散点图圈选** - 矩形/套索工具，Brush API实现
- **悬浮Sparkline** - 近8/13周趋势迷你图表
- **固定位置提示** - 无抖动悬浮卡片，16ms响应

### 3. 实时统计分析
- **圈选聚合** - Worker异步计算选中数据统计
- **统计指标** - count/sum/mean/median/stdev/share
- **局部斜率** - 样本>=5时计算敏感度
- **结果卡片** - 格式化数字展示，占比百分比

## 数据说明

### Walmart销售数据集（2010-2012）
- **数据规模**: 45家门店 × 143周 = 6,435条记录
- **时间跨度**: 2010-02-05 至 2012-10-26
- **核心字段**:
  - Store: 门店ID (1-45)
  - Date: 日期 (YYYY-MM-DD格式)
  - Weekly_Sales: 周销售额
  - Holiday_Flag: 节日标记 (0/1)
  - Temperature: 温度 (华氏度)
  - Fuel_Price: 油价
  - CPI: 消费者价格指数
  - Unemployment: 失业率
- **特殊日期**: Super Bowl、Valentine's Day、Labor Day、Thanksgiving、Christmas

## 开发指南

### 环境要求
- **Node.js**: 16.0+
- **npm**: 7.0+
- **浏览器**: 现代浏览器（Chrome 90+/Firefox 88+/Safari 14+）
- **依赖库**:
  - ECharts 5.5.0 (可视化)
  - D3.js (d3-array, d3-time-format等)
  - Acorn 8.15.0 (AST解析)
  - Vite 5.0.0 (开发服务器)

### 构建部署

```bash
# 生产构建
cd poc
npm run build

# 构建产物在 dist/ 目录
```

## 验收标准

### 功能验收
- ✅ **动态权重调参** - 6维特征滑块实时响应 <500ms
- ✅ **图表性能** - 柱状图5万条/散点图3万点流畅渲染
- ✅ **悬浮提示** - Sparkline稳定显示，无抖动 <16ms
- ✅ **圈选聚合** - 统计计算 <200ms，支持矩形/套索
- ✅ **Worker沙箱** - AST安全检查，5秒超时控制
- ✅ **参数管理** - 集中式管理，事件驱动更新
- ✅ **时间一致性** - UTC时间统一，确定性执行
- ✅ **错误处理** - 卡片化错误提示，5秒自动消失
- ✅ **快照机制** - JSON格式导出/导入，参数完整恢复

## 技术亮点

1. **模块化架构** - 清晰的职责分离，高内聚低耦合
2. **声明式参数** - 路径访问，事件驱动，Fail Fast
3. **安全沙箱** - AST双重验证，黑白名单结合
4. **特征工程** - 滚动窗口计算，Z-score标准化
5. **性能优化** - Worker异步，ECharts Canvas渲染
6. **用户体验** - 实时响应，无抖动交互，错误友好

## 后续优化方向

1. **安全增强** - 引入SES/Realms强隔离机制
2. **渲染优化** - WebGL支持超大数据集（10万+）
3. **计算优化** - 增量特征计算，避免全量重算
4. **性能加速** - WebAssembly加速核心计算
5. **测试覆盖** - 单元测试、集成测试完善
6. **功能扩展** - 更多统计模型、机器学习集成

## 贡献指南

欢迎提交Issue和Pull Request。请确保：
- 遵循现有代码风格
- 添加必要的测试
- 更新相关文档

## License

MIT