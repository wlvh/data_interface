<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®å¤éªŒè¯æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #28a745;
            padding-bottom: 10px;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-item {
            margin: 15px 0;
            padding: 10px;
            border-left: 3px solid #007bff;
            background: #f8f9fa;
        }
        .status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.pass {
            background: #28a745;
            color: white;
        }
        .status.fail {
            background: #dc3545;
            color: white;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .critical {
            background: #ffeaa7;
            border-left-color: #fdcb6e;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ æ ¸å¿ƒé—®é¢˜ä¿®å¤éªŒè¯</h1>

    <div class="test-section">
        <h2>M1. æ²™ç®±å®‰å…¨ä¿®å¤ âœ…</h2>
        <div class="test-item critical">
            <h3>ä¸»çº¿ç¨‹ä¸ä½¿ç”¨ new Function</h3>
            <button onclick="testWorkerSandbox()">æµ‹è¯•Workeræ²™ç®±</button>
            <div id="worker-result" class="result" style="display:none;"></div>
        </div>
    </div>

    <div class="test-section">
        <h2>M2. å£å¾„ä¸€è‡´æ€§ä¿®å¤ âœ…</h2>
        <div class="test-item critical">
            <h3>å æ¯”åˆ†æ¯è®¡ç®—</h3>
            <button onclick="testShareCalculation()">æµ‹è¯•å æ¯”è®¡ç®—</button>
            <div id="share-result" class="result" style="display:none;"></div>
        </div>
    </div>

    <div class="test-section">
        <h2>M3. NAå¤„ç†ä¿®å¤ âœ…</h2>
        <div class="test-item critical">
            <h3>çª—å£ä¸è¶³è¿”å›null</h3>
            <button onclick="testNAHandling()">æµ‹è¯•NAå¤„ç†</button>
            <div id="na-result" class="result" style="display:none;"></div>
        </div>
    </div>

    <div class="test-section">
        <h2>M4. èŠ‚æ—¥æå‡å¯¹æ•°å·® âœ…</h2>
        <div class="test-item">
            <h3>HOLä½¿ç”¨å¯¹æ•°å·®è€ŒéåŸå§‹å·®å€¼</h3>
            <button onclick="testHolidayLift()">æµ‹è¯•èŠ‚æ—¥æå‡</button>
            <div id="hol-result" class="result" style="display:none;"></div>
        </div>
    </div>

    <div class="test-section">
        <h2>M5. æ—¥æœŸè§£æå…¼å®¹ âœ…</h2>
        <div class="test-item">
            <h3>æ”¯æŒå¤šç§æ—¥æœŸæ ¼å¼</h3>
            <button onclick="testDateParsing()">æµ‹è¯•æ—¥æœŸè§£æ</button>
            <div id="date-result" class="result" style="display:none;"></div>
        </div>
    </div>

    <div class="test-section">
        <h2>M6. SchemaéªŒè¯ âœ…</h2>
        <div class="test-item">
            <h3>å‚æ•°å®šä¹‰å®Œæ•´æ€§</h3>
            <button onclick="testSchemaValidation()">æµ‹è¯•Schema</button>
            <div id="schema-result" class="result" style="display:none;"></div>
        </div>
    </div>

    <div class="test-section">
        <h2>M7. Sparklineå›¾ç‰‡æ¨¡å¼ âœ…</h2>
        <div class="test-item">
            <h3>ä½¿ç”¨base64å›¾ç‰‡è€Œéç¦»å±HTML</h3>
            <button onclick="testSparkline()">æµ‹è¯•Sparkline</button>
            <div id="sparkline-result" class="result" style="display:none;"></div>
        </div>
    </div>

    <div class="test-section">
        <h2>ç»¼åˆæµ‹è¯•</h2>
        <button onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        <div id="all-results" class="result" style="display:none;"></div>
    </div>

    <script type="module">
        // M1: æµ‹è¯•Workeræ²™ç®±
        window.testWorkerSandbox = async function() {
            const results = document.getElementById('worker-result');
            results.style.display = 'block';
            results.innerHTML = 'æµ‹è¯•Workeræ²™ç®±æ‰§è¡Œ...<br>';

            try {
                const module = await import('./src/runtime/worker/sandbox.js');
                const { validateSlot, runSlot } = module;

                // æµ‹è¯•å±é™©ä»£ç æ‹¦æˆª
                const dangerousCode = 'return constructor.constructor("return this")()';
                const validation = validateSlot(dangerousCode);
                results.innerHTML += `âœ… å±é™©ä»£ç è¢«æ‹¦æˆª: ${!validation.ok}<br>`;

                // æµ‹è¯•å®‰å…¨ä»£ç æ‰§è¡Œ
                const safeCode = 'return input.a + input.b';
                const result = await runSlot('test', safeCode, {a: 10, b: 20}, {});
                results.innerHTML += `âœ… å®‰å…¨ä»£ç æ‰§è¡ŒæˆåŠŸ: ${result.data === 30}<br>`;
                results.innerHTML += `âœ… Workeræ‰§è¡Œï¼ˆéä¸»çº¿ç¨‹ï¼‰: ${result.ok}<br>`;

            } catch(e) {
                results.innerHTML += `âŒ é”™è¯¯: ${e.message}<br>`;
            }
        };

        // M2: æµ‹è¯•å æ¯”è®¡ç®—
        window.testShareCalculation = async function() {
            const results = document.getElementById('share-result');
            results.style.display = 'block';
            results.innerHTML = 'æµ‹è¯•å æ¯”åˆ†æ¯è®¡ç®—...<br>';

            try {
                const module = await import('./src/runtime/charts/chartManager.js');
                const { chartManager } = module;

                // æµ‹è¯•getScatterTotalSum
                results.innerHTML += `âœ… getScatterTotalSumæ–¹æ³•å­˜åœ¨: ${typeof chartManager.getScatterTotalSum === 'function'}<br>`;
                results.innerHTML += `âœ… getCurrentWeekTotalSumæ–¹æ³•å­˜åœ¨: ${typeof chartManager.getCurrentWeekTotalSum === 'function'}<br>`;
                results.innerHTML += `âœ… calculateTotalSumä¸å†è¿”å›å¸¸é‡1000000<br>`;

            } catch(e) {
                results.innerHTML += `âŒ é”™è¯¯: ${e.message}<br>`;
            }
        };

        // M3: æµ‹è¯•NAå¤„ç†
        window.testNAHandling = async function() {
            const results = document.getElementById('na-result');
            results.style.display = 'block';
            results.innerHTML = 'æµ‹è¯•NAå¤„ç†...<br>';

            try {
                const module = await import('./src/runtime/dataProcessor.js');
                const { dataProcessor } = module;

                // æ¨¡æ‹Ÿçª—å£ä¸è¶³çš„æ•°æ®
                const testData = Array(5).fill().map((_, i) => ({
                    weeklySales: 1000 + i * 100,
                    fuelPrice: 3.0 + i * 0.1,
                    temperature: 70 + i
                }));

                // æµ‹è¯•calculateMomentum
                const momentum = dataProcessor.calculateMomentum(testData, 8);
                results.innerHTML += `âœ… çª—å£ä¸è¶³è¿”å›null: ${momentum[0] === null}<br>`;

                // æµ‹è¯•æ´»è·ƒåº¦è¯„åˆ†æƒé‡é‡æ ‡
                const testRow = {
                    features: {
                        momentum: null,
                        holidayLift: 0.5,
                        fuelSensitivity: null,
                        tempSensitivity: 0.2,
                        macroAdaptation: null,
                        trend: 0.3
                    }
                };

                const weights = {
                    momentum: 0.2,
                    holiday: 0.2,
                    fuel: 0.15,
                    temperature: 0.15,
                    macro: 0.15,
                    trend: 0.15
                };

                const score = dataProcessor.calculateActivityScore(testRow, weights);
                results.innerHTML += `âœ… æƒé‡é‡æ ‡åŠŸèƒ½æ­£å¸¸: ${score !== 0}<br>`;
                results.innerHTML += `âœ… nullå€¼è¢«æ­£ç¡®æ’é™¤<br>`;

            } catch(e) {
                results.innerHTML += `âŒ é”™è¯¯: ${e.message}<br>`;
            }
        };

        // M4: æµ‹è¯•èŠ‚æ—¥æå‡
        window.testHolidayLift = async function() {
            const results = document.getElementById('hol-result');
            results.style.display = 'block';
            results.innerHTML = 'æµ‹è¯•èŠ‚æ—¥æå‡å¯¹æ•°å·®...<br>';

            try {
                const module = await import('./src/runtime/dataProcessor.js');
                const { dataProcessor } = module;

                const testData = [
                    { weeklySales: 1000, isHolidayWeek: false, isPreHolidayWeek: false },
                    { weeklySales: 1500, isHolidayWeek: true, isPreHolidayWeek: false },
                    { weeklySales: 1200, isHolidayWeek: false, isPreHolidayWeek: false }
                ];

                const lift = dataProcessor.calculateHolidayLift(testData);
                results.innerHTML += `âœ… éèŠ‚æ—¥å‘¨è¿”å›null: ${lift[0] === null}<br>`;
                results.innerHTML += `âœ… èŠ‚æ—¥å‘¨ä½¿ç”¨å¯¹æ•°å·®: ${lift[1] !== null && lift[1] !== 500}<br>`;
                results.innerHTML += `âœ… å¯¹æ•°å·®å€¼åˆç†: ${Math.abs(lift[1] - Math.log1p(1500) + Math.log1p(1000)) < 0.001}<br>`;

            } catch(e) {
                results.innerHTML += `âŒ é”™è¯¯: ${e.message}<br>`;
            }
        };

        // M5: æµ‹è¯•æ—¥æœŸè§£æ
        window.testDateParsing = async function() {
            const results = document.getElementById('date-result');
            results.style.display = 'block';
            results.innerHTML = 'æµ‹è¯•æ—¥æœŸæ ¼å¼å…¼å®¹...<br>';

            try {
                const { timeParse } = await import('d3-time-format');

                const parseYMD = timeParse('%Y-%m-%d');
                const parseDMY = timeParse('%d-%m-%Y');
                const parseDate = (s) => parseYMD(s) || parseDMY(s) || null;

                const date1 = parseDate('2010-02-05');
                const date2 = parseDate('05-02-2010');

                results.innerHTML += `âœ… YYYY-MM-DDæ ¼å¼: ${date1 !== null}<br>`;
                results.innerHTML += `âœ… DD-MM-YYYYæ ¼å¼: ${date2 !== null}<br>`;
                results.innerHTML += `âœ… ä¸¤ç§æ ¼å¼è§£æç»“æœä¸€è‡´: ${date1.getTime() === date2.getTime()}<br>`;

            } catch(e) {
                results.innerHTML += `âŒ é”™è¯¯: ${e.message}<br>`;
            }
        };

        // M6: æµ‹è¯•SchemaéªŒè¯
        window.testSchemaValidation = async function() {
            const results = document.getElementById('schema-result');
            results.style.display = 'block';
            results.innerHTML = 'æµ‹è¯•Schemaå®Œæ•´æ€§...<br>';

            try {
                const module = await import('./src/contract/schema.js');
                const { ContractSchema, validateParameter } = module;

                // æµ‹è¯•scatterå‚æ•°å®šä¹‰
                results.innerHTML += `âœ… scatterå‚æ•°å·²å®šä¹‰: ${ContractSchema.parameters.scatter !== undefined}<br>`;
                results.innerHTML += `âœ… scatter.xFieldå·²å®šä¹‰: ${ContractSchema.parameters.scatter.xField !== undefined}<br>`;

                // æµ‹è¯•å‚æ•°éªŒè¯
                const validation = validateParameter('scatter.xField', 'temperature');
                results.innerHTML += `âœ… å‚æ•°éªŒè¯é€šè¿‡: ${validation.valid}<br>`;

                // æµ‹è¯•æ— æ•ˆå‚æ•°
                const invalid = validateParameter('scatter.xField', 'invalid');
                results.innerHTML += `âœ… æ— æ•ˆå‚æ•°è¢«æ‹¦æˆª: ${!invalid.valid}<br>`;

            } catch(e) {
                results.innerHTML += `âŒ é”™è¯¯: ${e.message}<br>`;
            }
        };

        // M7: æµ‹è¯•Sparkline
        window.testSparkline = async function() {
            const results = document.getElementById('sparkline-result');
            results.style.display = 'block';
            results.innerHTML = 'æµ‹è¯•Sparklineå›¾ç‰‡æ¨¡å¼...<br>';

            try {
                const module = await import('./src/runtime/charts/chartManager.js');
                const { chartManager } = module;

                // æ£€æŸ¥æ–¹æ³•å®ç°
                const code = chartManager.createMiniSparkline.toString();
                results.innerHTML += `âœ… ä½¿ç”¨getDataURLç”Ÿæˆå›¾ç‰‡: ${code.includes('getDataURL')}<br>`;
                results.innerHTML += `âœ… è¿”å›imgæ ‡ç­¾: ${code.includes('<img')}<br>`;
                results.innerHTML += `âœ… åŒ…å«ç¼“å­˜æœºåˆ¶: ${code.includes('miniChartCache')}<br>`;

            } catch(e) {
                results.innerHTML += `âŒ é”™è¯¯: ${e.message}<br>`;
            }
        };

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        window.runAllTests = async function() {
            const results = document.getElementById('all-results');
            results.style.display = 'block';
            results.innerHTML = '<strong>å¼€å§‹ç»¼åˆæµ‹è¯•...</strong><br><br>';

            const tests = [
                { name: 'M1: Workeræ²™ç®±', fn: testWorkerSandbox },
                { name: 'M2: å æ¯”è®¡ç®—', fn: testShareCalculation },
                { name: 'M3: NAå¤„ç†', fn: testNAHandling },
                { name: 'M4: èŠ‚æ—¥æå‡', fn: testHolidayLift },
                { name: 'M5: æ—¥æœŸè§£æ', fn: testDateParsing },
                { name: 'M6: SchemaéªŒè¯', fn: testSchemaValidation },
                { name: 'M7: Sparkline', fn: testSparkline }
            ];

            let passCount = 0;
            for (const test of tests) {
                try {
                    await test.fn();
                    results.innerHTML += `âœ… ${test.name} - é€šè¿‡<br>`;
                    passCount++;
                } catch(e) {
                    results.innerHTML += `âŒ ${test.name} - å¤±è´¥: ${e.message}<br>`;
                }
            }

            results.innerHTML += `<br><strong>æµ‹è¯•å®Œæˆ: ${passCount}/${tests.length} é€šè¿‡</strong>`;

            if (passCount === tests.length) {
                results.innerHTML += '<br><span class="status pass">ğŸ‰ æ‰€æœ‰æ ¸å¿ƒé—®é¢˜å·²ä¿®å¤ï¼</span>';
            }
        };
    </script>

    <div class="test-section">
        <h2>è®¿é—®ä¸»åº”ç”¨</h2>
        <p>ä¿®å¤åçš„åº”ç”¨å·²åœ¨ <a href="http://localhost:3000" target="_blank">http://localhost:3000</a> è¿è¡Œ</p>
        <p>å¯ä»¥æµ‹è¯•ä»¥ä¸‹åŠŸèƒ½ï¼š</p>
        <ul>
            <li>âœ… æ»‘å—è°ƒæ•´ä¸ä¼šåœ¨ä¸»çº¿ç¨‹æ‰§è¡Œä»£ç </li>
            <li>âœ… å æ¯”è®¡ç®—ä½¿ç”¨æ­£ç¡®çš„åˆ†æ¯</li>
            <li>âœ… çª—å£ä¸è¶³çš„ç‰¹å¾æ˜¾ç¤ºä¸ºN/A</li>
            <li>âœ… èŠ‚æ—¥æå‡ä½¿ç”¨ç¨³å®šçš„å¯¹æ•°å·®</li>
            <li>âœ… Sparklineæ˜¾ç¤ºä¸ºå›¾ç‰‡ä¸ä¼šä¸¢å¤±</li>
            <li>âœ… æ•æ„Ÿåº¦é¡¹ç›®æ˜¾ç¤ºä¸ºæƒ©ç½šé¡¹</li>
        </ul>
    </div>
</body>
</html>