<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ğŸ”§ ç»Ÿä¸€æµ‹è¯•ä¸­å¿ƒ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        h1 {
            color: #333;
            border-bottom: 3px solid #007bff;
            padding-bottom: 10px;
        }

        .test-category {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .test-category h2 {
            color: #007bff;
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-item {
            border-left: 3px solid #ddd;
            padding: 15px;
            margin: 15px 0;
            background: #fafafa;
            transition: all 0.3s;
        }

        .test-item.critical {
            border-left-color: #ff4444;
        }

        .test-item.running {
            background: #fff3cd;
            border-left-color: #ffc107;
        }

        .test-item.passed {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .test-item.failed {
            background: #f8d7da;
            border-left-color: #dc3545;
        }

        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .test-title {
            font-weight: bold;
            font-size: 16px;
        }

        .test-status {
            font-size: 14px;
            padding: 2px 8px;
            border-radius: 4px;
            background: #6c757d;
            color: white;
        }

        .control-panel {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        button:hover {
            background: #0056b3;
        }

        button.secondary {
            background: #6c757d;
        }

        button.secondary:hover {
            background: #545b62;
        }

        button.success {
            background: #28a745;
        }

        button.success:hover {
            background: #218838;
        }

        .result {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            margin-top: 10px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-item {
            flex: 1;
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #007bff;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }

        .filter-tabs {
            display: flex;
            gap: 5px;
            margin: 15px 0;
            border-bottom: 2px solid #ddd;
        }

        .filter-tab {
            padding: 8px 16px;
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .filter-tab.active {
            color: #007bff;
            border-bottom-color: #007bff;
            font-weight: bold;
        }

        .hidden {
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ ç»Ÿä¸€æµ‹è¯•ä¸­å¿ƒ</h1>

    <!-- ç»Ÿè®¡é¢æ¿ -->
    <div class="stats">
        <div class="stat-item">
            <div class="stat-value" id="total-count">0</div>
            <div class="stat-label">æ€»æµ‹è¯•æ•°</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="passed-count" style="color: #28a745;">0</div>
            <div class="stat-label">é€šè¿‡</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="failed-count" style="color: #dc3545;">0</div>
            <div class="stat-label">å¤±è´¥</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="pending-count" style="color: #6c757d;">0</div>
            <div class="stat-label">å¾…æµ‹è¯•</div>
        </div>
    </div>

    <!-- è¿›åº¦æ¡ -->
    <div class="progress-bar">
        <div class="progress-fill" id="progress-fill">0%</div>
    </div>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="control-panel">
        <button onclick="runAllTests()" class="success">â–¶ï¸ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        <button onclick="runCriticalTests()">ğŸ”´ ä»…è¿è¡Œå…³é”®æµ‹è¯•</button>
        <button onclick="clearResults()" class="secondary">ğŸ”„ æ¸…é™¤ç»“æœ</button>
        <button onclick="exportResults()">ğŸ“Š å¯¼å‡ºæŠ¥å‘Š</button>
    </div>

    <!-- è¿‡æ»¤æ ‡ç­¾ -->
    <div class="filter-tabs">
        <button class="filter-tab active" onclick="filterTests('all')">å…¨éƒ¨</button>
        <button class="filter-tab" onclick="filterTests('critical')">å…³é”®æµ‹è¯•</button>
        <button class="filter-tab" onclick="filterTests('passed')">å·²é€šè¿‡</button>
        <button class="filter-tab" onclick="filterTests('failed')">å¤±è´¥</button>
    </div>

    <!-- æµ‹è¯•å®¹å™¨ -->
    <div id="test-container"></div>

    <script type="module">
        // å¯¼å…¥æ‰€éœ€æ¨¡å—
        import { validateSlot, runSlot } from './src/runtime/worker/sandbox.js';
        import { chartManager } from './src/runtime/charts/chartManager.js';
        import { paramManager } from './src/runtime/params/manager.js';
        import { dataProcessor } from './src/runtime/dataProcessor.js';

        // æµ‹è¯•çŠ¶æ€ç®¡ç†
        const testState = {
            results: new Map(),
            stats: {
                total: 0,
                passed: 0,
                failed: 0,
                pending: 0
            }
        };

        // å®šä¹‰æµ‹è¯•å¥—ä»¶
        const testSuites = [
            {
                name: 'æ ¸å¿ƒå®‰å…¨ä¿®å¤',
                icon: 'ğŸ›¡ï¸',
                tests: [
                    {
                        id: 'security-sandbox',
                        name: 'æ²™ç®±å®‰å…¨ä¿®å¤éªŒè¯',
                        critical: true,
                        testFn: async (log) => {
                            log('æµ‹è¯•å±é™©ä»£ç æ‹¦æˆª...');
                            const dangerousCode = 'return constructor.constructor("return this")()';
                            const validation = validateSlot(dangerousCode);
                            log(`å±é™©ä»£ç è¢«æ‹¦æˆª: ${!validation.ok ? 'âœ…' : 'âŒ'}`);

                            log('æµ‹è¯•å®‰å…¨ä»£ç æ‰§è¡Œ...');
                            const safeCode = 'return input.a + input.b';
                            const result = await runSlot('test', safeCode, {a: 10, b: 20}, {});
                            log(`å®‰å…¨ä»£ç æ‰§è¡Œç»“æœ: ${result.data} ${result.data === 30 ? 'âœ…' : 'âŒ'}`);

                            return !validation.ok && result.data === 30;
                        }
                    },
                    {
                        id: 'security-eval-block',
                        name: 'eval/Function æ‹¦æˆªæµ‹è¯•',
                        critical: true,
                        testFn: async (log) => {
                            const testCases = [
                                { code: 'return eval("1+1")', desc: 'evalç›´æ¥è°ƒç”¨' },
                                { code: 'return new Function("return 1+1")()', desc: 'Functionæ„é€ ' },
                                { code: 'const e = eval; return e("1+1")', desc: 'evalé—´æ¥å¼•ç”¨' }
                            ];

                            let allBlocked = true;
                            for (const test of testCases) {
                                log(`æµ‹è¯• ${test.desc}...`);
                                const validation = validateSlot(test.code);
                                const blocked = !validation.ok;
                                log(`${test.desc}: ${blocked ? 'âœ… å·²æ‹¦æˆª' : 'âŒ æœªæ‹¦æˆª'}`);
                                allBlocked = allBlocked && blocked;
                            }

                            return allBlocked;
                        }
                    }
                ]
            },
            {
                name: 'æ•°æ®å¤„ç†åŠŸèƒ½',
                icon: 'ğŸ“Š',
                tests: [
                    {
                        id: 'data-rolling-window',
                        name: 'æ»šåŠ¨çª—å£è®¡ç®—ä¼˜åŒ–',
                        critical: false,
                        testFn: async (log) => {
                            log('å‡†å¤‡æµ‹è¯•æ•°æ®...');
                            const testData = Array.from({length: 30}, (_, i) => ({
                                weeklySales: 1000 + i * 10,
                                fuelPrice: 3.5 + Math.random() * 0.5,
                                temperature: 70 + Math.random() * 20,
                                unemployment: 5 + Math.random() * 2,
                                cpi: 200 + i * 0.1
                            }));

                            log('æµ‹è¯•åŠ¨é‡è®¡ç®—...');
                            const momentum = dataProcessor.calculateMomentum(testData, 8);
                            const validMomentum = momentum.filter(m => m !== null).length > 0;
                            log(`åŠ¨é‡è®¡ç®—: ${validMomentum ? 'âœ…' : 'âŒ'} (æœ‰æ•ˆå€¼: ${momentum.filter(m => m !== null).length})`);

                            log('æµ‹è¯•æ²¹ä»·æ•æ„Ÿåº¦è®¡ç®—...');
                            const fuelSens = dataProcessor.calculateFuelSensitivity(testData, 10);
                            const validFuel = fuelSens.filter(f => f !== null).length > 0;
                            log(`æ²¹ä»·æ•æ„Ÿåº¦: ${validFuel ? 'âœ…' : 'âŒ'} (æœ‰æ•ˆå€¼: ${fuelSens.filter(f => f !== null).length})`);

                            return validMomentum && validFuel;
                        }
                    },
                    {
                        id: 'data-feature-calc',
                        name: 'ç‰¹å¾è®¡ç®—å®Œæ•´æ€§',
                        critical: false,
                        testFn: async (log) => {
                            log('åŠ è½½CSVæ•°æ®...');
                            const response = await fetch('/Walmart.csv');
                            const csvText = await response.text();
                            const data = await dataProcessor.loadData(csvText);

                            log(`æ•°æ®åŠ è½½æˆåŠŸ: ${data.length} æ¡è®°å½•`);

                            const storeFeatures = dataProcessor.storeFeatures;
                            log(`è®¡ç®—äº† ${storeFeatures.size} ä¸ªé—¨åº—çš„ç‰¹å¾`);

                            // æ£€æŸ¥ç¬¬ä¸€ä¸ªé—¨åº—çš„ç‰¹å¾
                            const firstStore = storeFeatures.values().next().value;
                            const features = ['momentum', 'holidayLift', 'fuelSensitivity', 'tempSensitivity', 'macroAdaptation', 'trend'];
                            let allFeaturesExist = true;

                            for (const feature of features) {
                                const exists = firstStore[feature] !== undefined;
                                log(`ç‰¹å¾ ${feature}: ${exists ? 'âœ…' : 'âŒ'}`);
                                allFeaturesExist = allFeaturesExist && exists;
                            }

                            return allFeaturesExist;
                        }
                    }
                ]
            },
            {
                name: 'å›¾è¡¨ç®¡ç†å™¨',
                icon: 'ğŸ“ˆ',
                tests: [
                    {
                        id: 'chart-scatter-total',
                        name: 'æ•£ç‚¹å›¾åˆ†æ¯è®¡ç®—',
                        critical: true,
                        testFn: (log) => {
                            log('æ£€æŸ¥ getScatterTotalSum æ–¹æ³•...');
                            const methodExists = typeof chartManager.getScatterTotalSum === 'function';
                            log(`æ–¹æ³•å­˜åœ¨: ${methodExists ? 'âœ…' : 'âŒ'}`);

                            if (methodExists) {
                                log('æµ‹è¯•è®¡ç®—é€»è¾‘...');
                                // æ¨¡æ‹Ÿè®¾ç½®æ€»é”€å”®é¢
                                chartManager.scatterTotalSum = 1000000;
                                const total = chartManager.getScatterTotalSum();
                                log(`è·å–æ€»é”€å”®é¢: ${total}`);
                                return total === 1000000;
                            }

                            return methodExists;
                        }
                    },
                    {
                        id: 'chart-update-method',
                        name: 'å›¾è¡¨æ›´æ–°æ–¹æ³•',
                        critical: false,
                        testFn: (log) => {
                            const methods = ['updateScatterChart', 'updateActivityChart', 'updateMissingDataChart'];
                            let allExist = true;

                            for (const method of methods) {
                                const exists = typeof chartManager[method] === 'function';
                                log(`${method}: ${exists ? 'âœ…' : 'âŒ'}`);
                                allExist = allExist && exists;
                            }

                            return allExist;
                        }
                    }
                ]
            },
            {
                name: 'å‚æ•°ç®¡ç†å™¨',
                icon: 'âš™ï¸',
                tests: [
                    {
                        id: 'param-validation',
                        name: 'å‚æ•°éªŒè¯æœºåˆ¶',
                        critical: false,
                        testFn: (log) => {
                            log('æµ‹è¯•å‚æ•°è®¾ç½®...');
                            const testParam = 'feature.weights.momentum';
                            const originalValue = paramManager.get(testParam);

                            log(`åŸå§‹å€¼: ${originalValue}`);

                            // æµ‹è¯•æœ‰æ•ˆå€¼
                            paramManager.set(testParam, 0.5);
                            const newValue = paramManager.get(testParam);
                            log(`è®¾ç½® 0.5: ${newValue === 0.5 ? 'âœ…' : 'âŒ'}`);

                            // æµ‹è¯•è¾¹ç•Œå€¼
                            paramManager.set(testParam, 0);
                            const zeroValue = paramManager.get(testParam);
                            log(`è®¾ç½® 0: ${zeroValue === 0 ? 'âœ…' : 'âŒ'}`);

                            // æ¢å¤åŸå§‹å€¼
                            paramManager.set(testParam, originalValue);

                            return newValue === 0.5 && zeroValue === 0;
                        }
                    },
                    {
                        id: 'param-schema',
                        name: 'Schema æ ¡éªŒ',
                        critical: false,
                        testFn: (log) => {
                            log('æµ‹è¯•æƒé‡å‚æ•°èŒƒå›´...');
                            const weights = paramManager.get('feature.weights');
                            let allValid = true;

                            for (const [key, value] of Object.entries(weights)) {
                                const valid = value >= 0 && value <= 1;
                                log(`${key}: ${value} ${valid ? 'âœ…' : 'âŒ'}`);
                                allValid = allValid && valid;
                            }

                            return allValid;
                        }
                    }
                ]
            }
        ];

        // æ¸²æŸ“æµ‹è¯•ç•Œé¢
        function renderTests() {
            const container = document.getElementById('test-container');
            container.innerHTML = '';

            testSuites.forEach(suite => {
                const suiteDiv = document.createElement('div');
                suiteDiv.className = 'test-category';
                suiteDiv.innerHTML = `
                    <h2>${suite.icon} ${suite.name}</h2>
                    <div class="suite-tests"></div>
                `;

                const testsContainer = suiteDiv.querySelector('.suite-tests');

                suite.tests.forEach(test => {
                    const testDiv = document.createElement('div');
                    testDiv.className = `test-item ${test.critical ? 'critical' : ''}`;
                    testDiv.dataset.testId = test.id;
                    testDiv.dataset.critical = test.critical;
                    testDiv.innerHTML = `
                        <div class="test-header">
                            <span class="test-title">
                                ${test.critical ? 'ğŸ”´' : 'âšª'} ${test.name}
                            </span>
                            <span class="test-status">å¾…æµ‹è¯•</span>
                        </div>
                        <button onclick="runSingleTest('${test.id}')">è¿è¡Œæµ‹è¯•</button>
                        <div class="result hidden"></div>
                    `;
                    testsContainer.appendChild(testDiv);
                });

                container.appendChild(suiteDiv);
            });

            updateStats();
        }

        // è¿è¡Œå•ä¸ªæµ‹è¯•
        async function runSingleTest(testId) {
            const test = findTestById(testId);
            if (!test) return;

            const testDiv = document.querySelector(`[data-test-id="${testId}"]`);
            const resultDiv = testDiv.querySelector('.result');
            const statusSpan = testDiv.querySelector('.test-status');

            // è®¾ç½®è¿è¡ŒçŠ¶æ€
            testDiv.className = `test-item ${test.critical ? 'critical' : ''} running`;
            statusSpan.textContent = 'è¿è¡Œä¸­...';
            statusSpan.style.background = '#ffc107';
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '';

            const log = (message) => {
                resultDiv.innerHTML += message + '\n';
            };

            try {
                const result = await test.testFn(log);

                // æ›´æ–°çŠ¶æ€
                if (result) {
                    testDiv.className = `test-item ${test.critical ? 'critical' : ''} passed`;
                    statusSpan.textContent = 'âœ… é€šè¿‡';
                    statusSpan.style.background = '#28a745';
                    testState.results.set(testId, 'passed');
                } else {
                    testDiv.className = `test-item ${test.critical ? 'critical' : ''} failed`;
                    statusSpan.textContent = 'âŒ å¤±è´¥';
                    statusSpan.style.background = '#dc3545';
                    testState.results.set(testId, 'failed');
                }
            } catch (error) {
                testDiv.className = `test-item ${test.critical ? 'critical' : ''} failed`;
                statusSpan.textContent = 'âŒ é”™è¯¯';
                statusSpan.style.background = '#dc3545';
                log(`é”™è¯¯: ${error.message}`);
                testState.results.set(testId, 'failed');
            }

            updateStats();
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            for (const suite of testSuites) {
                for (const test of suite.tests) {
                    await runSingleTest(test.id);
                    await new Promise(resolve => setTimeout(resolve, 100)); // å°å»¶è¿Ÿä»¥ä¾¿è§‚å¯Ÿè¿›åº¦
                }
            }
        }

        // è¿è¡Œå…³é”®æµ‹è¯•
        async function runCriticalTests() {
            for (const suite of testSuites) {
                for (const test of suite.tests) {
                    if (test.critical) {
                        await runSingleTest(test.id);
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                }
            }
        }

        // æ¸…é™¤ç»“æœ
        function clearResults() {
            testState.results.clear();
            document.querySelectorAll('.test-item').forEach(item => {
                item.className = `test-item ${item.dataset.critical === 'true' ? 'critical' : ''}`;
                item.querySelector('.test-status').textContent = 'å¾…æµ‹è¯•';
                item.querySelector('.test-status').style.background = '#6c757d';
                item.querySelector('.result').classList.add('hidden');
                item.querySelector('.result').innerHTML = '';
            });
            updateStats();
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            const allTests = [];
            testSuites.forEach(suite => {
                suite.tests.forEach(test => allTests.push(test));
            });

            testState.stats.total = allTests.length;
            testState.stats.passed = Array.from(testState.results.values()).filter(r => r === 'passed').length;
            testState.stats.failed = Array.from(testState.results.values()).filter(r => r === 'failed').length;
            testState.stats.pending = testState.stats.total - testState.stats.passed - testState.stats.failed;

            document.getElementById('total-count').textContent = testState.stats.total;
            document.getElementById('passed-count').textContent = testState.stats.passed;
            document.getElementById('failed-count').textContent = testState.stats.failed;
            document.getElementById('pending-count').textContent = testState.stats.pending;

            // æ›´æ–°è¿›åº¦æ¡
            const progress = ((testState.stats.passed + testState.stats.failed) / testState.stats.total) * 100;
            const progressFill = document.getElementById('progress-fill');
            progressFill.style.width = `${progress}%`;
            progressFill.textContent = `${Math.round(progress)}%`;
        }

        // è¿‡æ»¤æµ‹è¯•
        function filterTests(filter) {
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            document.querySelectorAll('.test-item').forEach(item => {
                const testId = item.dataset.testId;
                const status = testState.results.get(testId);
                const isCritical = item.dataset.critical === 'true';

                let show = true;
                switch(filter) {
                    case 'critical':
                        show = isCritical;
                        break;
                    case 'passed':
                        show = status === 'passed';
                        break;
                    case 'failed':
                        show = status === 'failed';
                        break;
                }

                item.style.display = show ? 'block' : 'none';
            });
        }

        // å¯¼å‡ºæŠ¥å‘Š
        function exportResults() {
            const report = {
                timestamp: new Date().toISOString(),
                stats: testState.stats,
                results: []
            };

            testSuites.forEach(suite => {
                suite.tests.forEach(test => {
                    const status = testState.results.get(test.id) || 'pending';
                    report.results.push({
                        suite: suite.name,
                        test: test.name,
                        critical: test.critical,
                        status: status
                    });
                });
            });

            const blob = new Blob([JSON.stringify(report, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `test-report-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // æŸ¥æ‰¾æµ‹è¯•
        function findTestById(testId) {
            for (const suite of testSuites) {
                const test = suite.tests.find(t => t.id === testId);
                if (test) return test;
            }
            return null;
        }

        // åˆå§‹åŒ–
        renderTests();

        // å¯¼å‡ºåˆ°å…¨å±€
        window.runSingleTest = runSingleTest;
        window.runAllTests = runAllTests;
        window.runCriticalTests = runCriticalTests;
        window.clearResults = clearResults;
        window.filterTests = filterTests;
        window.exportResults = exportResults;
    </script>
</body>
</html>